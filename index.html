<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>NiflLink ‚Äì Asatru</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      color: #e0f7ff;
      background: linear-gradient(to bottom, #0a001f 0%, #001133 40%, #0b1e3f 100%);
      background-attachment: fixed;
      position: relative;
      overflow: hidden;
    }
    body::before { /* hvƒõzdy */ content:""; position:absolute; inset:0;
      background: radial-gradient(white 1px,transparent 1px),
                  radial-gradient(white 1px,transparent 1px),
                  radial-gradient(white 1px,transparent 1px);
      background-size:60px 60px,40px 40px,80px 80px;
      background-position:0 0,30px 30px,15px 45px;
      opacity:0.15; pointer-events:none;
    }
    #aurora {
      position:absolute; bottom:0; left:0; right:0; height:40%;
      background:linear-gradient(to top, rgba(0,255,200,0) 0%, rgba(0,255,180,0.08)30%, rgba(100,255,220,0.15)50%, rgba(180,100,255,0.12)70%, rgba(255,80,180,0.08)90%, transparent 100%);
      opacity:0.4; transition:opacity 1.5s ease, transform 8s ease-in-out;
      pointer-events:none; filter:blur(40px);
    }
    body.speaking #aurora { opacity:0.85; transform:scale(1.05); }

    h2 { color:#c0ffff; text-shadow:0 0 10px #00ffcc; margin:1em 0; }
    button {
      padding:14px 32px; margin:12px; font-size:18px; color:white; border:none;
      border-radius:8px; cursor:pointer; transition:all 0.3s; box-shadow:0 4px 12px rgba(0,255,200,0.3);
    }
    button.connect { background:linear-gradient(#1a3c34,#2e5c50); }
    button.talk { background:linear-gradient(#3a1a1a,#5c2e2e); }
    button:hover { transform:scale(1.05); }
    button.speaking { background:linear-gradient(#b71c1c,#d32f2f); box-shadow:0 0 20px #ff5252; }

    .input-container { position:relative; display:inline-block; margin:20px 0; }
    #nameInput { width:220px; padding:12px; font-size:18px; background:rgba(0,0,0,0.5); color:#e0ffff; border:2px solid #00b8a9; border-radius:8px; }
    #rune-stone { position:absolute; top:0; left:50%; transform:translateX(-50%) translateY(-50%); pointer-events:none; width:260px; height:140px; }

    #status, #peers { background:rgba(0,0,0,0.5); padding:12px; border-radius:10px; margin:1em auto; max-width:600px; }

    .peer { display:inline-block; padding:8px 16px; margin:6px; background:rgba(0,40,60,0.7); border:1px solid #00b8a9; color:#e0ffff; border-radius:20px; }
    .speaking { background:rgba(180,0,80,0.8)!important; border-color:#ff4081; box-shadow:0 0 15px #ff79b0; }

    #qr-container { margin:20px auto; background:rgba(255,255,255,0.9); padding:10px; border-radius:12px; display:inline-block; cursor:pointer; }
    #raven-icon { width:48px; height:48px; vertical-align:middle; margin-right:10px; }
  </style>
</head>
<body>

  <div id="aurora"></div>

  <h2>NiflLink</h2>

  <div class="input-container">
    <input id="nameInput" placeholder="Zadej sv√© jm√©no" value="Filip">
    <svg id="rune-stone" viewBox="0 0 260 140">
      <rect x="10" y="10" width="240" height="120" rx="12" fill="none" stroke="none"/>
      <text id="rune-name" x="130" y="75" font-size="28" fill="#e0ffff" text-anchor="middle" font-family="serif">Filip</text>
      <g id="rune-circle"></g>
    </svg>
  </div>

  <button class="connect" onclick="connect()">üêâ Povolit mikrofon a p≈ôipojit</button>
  
  <br><br>
  <button id="talkBtn" class="talk" onclick="toggleTalk()" disabled style="display:none">
    <span id="snake">üêç</span> Mluv√≠m teƒè
  </button>

  <div id="status"></div>
  <div id="peers"></div>

  <div id="link-container" style="display:none; margin:30px 0;">
    <span>Tv≈Øj odkaz pro ostatn√≠:</span><br>
    <span id="link-text"></span>
    <div id="qr-container" onclick="copyLink()">
      <svg id="raven-icon" viewBox="0 0 100 100">
        <path d="M50 20 Q30 0 10 30 Q0 60 20 80 Q40 100 50 90 Q60 100 80 80 Q100 60 90 30 Q70 0 50 20 Z" fill="#000"/>
        <circle cx="35" cy="40" r="5" fill="#fff"/>
        <circle cx="65" cy="40" r="5" fill="#fff"/>
      </svg>
      <div id="qrcode"></div>
    </div>
  </div>

  <audio id="remoteAudios" autoplay style="display:none"></audio>

  <script>
    let myPeer, myStream, myId, myName = "";
    let peers = {};
    let isTalking = false;
    let link = "";

    const urlParams = new URLSearchParams(window.location.search);
    myName = urlParams.get('name') || "Anonym";
    document.getElementById("nameInput").value = myName;
    updateRuneStone();

    document.getElementById("nameInput").addEventListener("input", () => {
      myName = document.getElementById("nameInput").value.trim() || "Anonym";
      updateRuneStone();
    });

    function updateRuneStone() {
      document.getElementById("rune-name").textContent = myName;
      const circle = document.getElementById("rune-circle");
      circle.innerHTML = "";
      const runes = "·ö†·ö¢·ö¶·ö®·ö±·ö≤·ö∑·öπ·ö∫·öæ·õÅ·õÉ·õá·õà·õâ·õä·õè·õí·õñ·õó·õö·õú·õû·õü".split("");
      const count = Math.max(8, Math.min(24, myName.length * 2));
      const radius = 55;
      for (let i = 0; i < count; i++) {
        const angle = (i / count) * Math.PI * 2;
        const x = 130 + Math.cos(angle) * radius;
        const y = 70 + Math.sin(angle) * radius * 0.7;
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", x);
        text.setAttribute("y", y);
        text.setAttribute("font-size", "18");
        text.setAttribute("fill", "#8b5a2b");
        text.setAttribute("text-anchor", "middle");
        text.textContent = runes[i % runes.length];
        circle.appendChild(text);
      }
    }

    async function connect() {
      myName = document.getElementById("nameInput").value.trim() || "Anonym";
      try {
        myStream = await navigator.mediaDevices.getUserMedia({audio:true});
        document.getElementById("status").innerText = "P≈ôipojeno! ƒåek√°m na ostatn√≠...";
        myPeer = new Peer();
        myPeer.on('open', id => {
          myId = id;
          link = `${location.origin + location.pathname}?name=${encodeURIComponent(myName)}`;
          document.getElementById("link-text").textContent = link;
          new QRCode(document.getElementById("qrcode"), {
            text: link,
            width: 140,
            height: 140,
            colorDark: "#000000",
            colorLight: "#ffffff"
          });
          document.getElementById("link-container").style.display = "block";
          document.getElementById("talkBtn").style.display = "inline-block";
          document.getElementById("talkBtn").disabled = false;
        });
        myPeer.on('call', call => {
          call.answer(myStream);
          handleNewPeer(call.peer, call);
        });
      } catch(e) {
        alert("Chyba mikrofonu: " + e.message);
      }
    }

    function toggleTalk() {
      isTalking = !isTalking;
      document.body.classList.toggle("speaking", isTalking);
      const btn = document.getElementById("talkBtn");
      btn.innerHTML = isTalking 
        ? '<span id="snake" style="animation: hiss 1.2s infinite;">üêç</span> P≈ôesta≈à mluvit'
        : '<span id="snake">üêç</span> Mluv√≠m teƒè';
      btn.className = isTalking ? "talk speaking" : "talk";

      Object.values(peers).forEach(p => {
        if (p.call && p.call.open) {
          p.call.peerConnection?.getDataChannels()?.[0]?.send(JSON.stringify({
            type: "talking", value: isTalking, name: myName
          }));
        }
      });
    }

    function handleNewPeer(peerId, call = null) {
      if (peers[peerId]) return;
      peers[peerId] = {name: "?", call, isTalking: false};
      if (!call) {
        const outgoing = myPeer.call(peerId, myStream);
        outgoing.on('stream', () => {});
        peers[peerId].call = outgoing;
      }
      updatePeersList();
    }

    function updatePeersList() {
      const div = document.getElementById("peers");
      div.innerHTML = "<b>P≈ôipojeni:</b><br>";
      for (let id in peers) {
        let cls = peers[id].isTalking ? "peer speaking" : "peer";
        div.innerHTML += `<span class="${cls}">${peers[id].name || id.slice(0,6)}</span>`;
      }
    }

    myPeer?.on('connection', conn => {
      conn.on('data', data => {
        if (data.type === "talking" && peers[conn.peer]) {
          peers[conn.peer].isTalking = data.value;
          peers[conn.peer].name = data.name || peers[conn.peer].name;
          updatePeersList();
        }
      });
    });

    function copyLink() {
      navigator.clipboard.writeText(link);
      alert("Odkaz zkop√≠rov√°n!");
    }
  </script>
  <style>
    @keyframes hiss {
      0%,100% { transform:scaleX(1); }
      50% { transform:scaleX(1.3); }
    }
  </style>
</body>
</html>
