<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Veritatem Loquere</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: #003399;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .stars {
      position: absolute;
      width: 460px;
      height: 460px;
    }

    .star {
      position: absolute;
      width: 32px;
      height: 32px;
      background: #FFCC00;
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      transition: all 0.5s ease;
      box-shadow: 0 0 15px #FFCC00;
    }

    .star.active {
      background: #ffff44;
      box-shadow: 0 0 30px #ffff00, 0 0 50px #ffff88;
      transform: scale(1.4);
    }

    .center-button {
      position: relative;
      z-index: 10;
      padding: 28px 60px;
      font-size: 32px;
      font-weight: bold;
      background: #FFCC00;
      color: #003399;
      border: none;
      border-radius: 60px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(255, 204, 0, 0.6);
      transition: all 0.3s;
    }

    .center-button:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 40px rgba(255, 204, 0, 0.8);
    }

    h1 {
      position: absolute;
      top: 70px;
      font-size: 48px;
      letter-spacing: 6px;
      text-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
  </style>
</head>
<body>

  <h1>Veritatem Loquere</h1>

  <div class="stars" id="starsContainer"></div>

  <button class="center-button" id="startBtn">
    Veritatem Loquere
  </button>

  <audio id="remoteAudios" autoplay style="display:none"></audio>

  <script>
    const totalSeats = 12;
    let mySeat = -1;
    let myPeer, myStream;
    let peers = {};

    const container = document.getElementById('starsContainer');
    const startBtn = document.getElementById('startBtn');

    function createStars() {
      for (let i = 0; i < totalSeats; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.id = 'star-' + i;
        
        const angle = (i * 360) / totalSeats - 90;
        const rad = angle * Math.PI / 180;
        const radius = 170;
        const x = 230 + Math.cos(rad) * radius;
        const y = 230 + Math.sin(rad) * radius;
        
        star.style.left = x + 'px';
        star.style.top = y + 'px';
        container.appendChild(star);
      }
    }

    createStars();

    startBtn.addEventListener('click', async () => {
      startBtn.textContent = "Připojuji...";
      startBtn.disabled = true;

      try {
        myStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        myPeer = new Peer();

        myPeer.on('open', () => {
          startBtn.style.display = "none";
          assignSeat();
        });

        myPeer.on('call', call => {
          call.answer(myStream);
          handleNewPeer(call.peer, call);
        });

      } catch(e) {
        alert("Mikrofon nebyl povolen.");
        startBtn.disabled = false;
        startBtn.textContent = "MLUV PRAVDU";
      }
    });

    function assignSeat() {
      for (let i = 0; i < totalSeats; i++) {
        const star = document.getElementById('star-' + i);
        if (!star.classList.contains('active')) {
          mySeat = i;
          star.classList.add('active');
          break;
        }
      }
    }

    function handleNewPeer(peerId, call) {
      peers[peerId] = {call};

      if (call) {
        call.on('stream', stream => {
          const audio = document.getElementById('remoteAudios');
          audio.srcObject = stream;
          audio.play();
        });
      }
    }

    // Pro testování mluvícího (zmáčkni mezerník)
    document.addEventListener('keydown', (e) => {
      if (e.key === " " && mySeat !== -1) {
        const star = document.getElementById('star-' + mySeat);
        star.style.transition = "all 0.2s";
        star.style.transform = "scale(1.6)";
        setTimeout(() => star.style.transform = "scale(1.4)", 300);
      }
    });
  </script>
</body>
</html>
